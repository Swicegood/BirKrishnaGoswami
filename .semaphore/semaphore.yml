version: v1.0
name: Expo Web App Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  - name: Build
    task:
      env_vars:
        - name: NODE_ENV
          value: production
      jobs:
        - name: Export Expo Web
          commands:
            - checkout
            - node --version
            - npm --version
            - npm install
            - node -e "const fs = require('fs'); const config = JSON.parse(fs.readFileSync('app.json', 'utf8')); if (config.expo && config.expo.plugins) { config.expo.plugins = config.expo.plugins.filter(plugin => !Array.isArray(plugin) || plugin[0] !== 'expo-build-properties'); fs.writeFileSync('app.json', JSON.stringify(config, null, 2)); }"
            - npx expo export --platform web --clear --no-install

  - name: Deploy
    task:
      jobs:
        - name: Deploy to VPS
          commands:
            - checkout
            - ssh-keyscan -H $VPS_IP >> ~/.ssh/known_hosts
            - 'scp -r dist/* $VPS_USER@$VPS_IP:/public_html/'
      secrets:
        - name: VPS